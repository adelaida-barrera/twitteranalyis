---
title: "Scaling feminist accounts"
author: "Adelaida Barrera"
date: "12/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(quanteda)
library(ca)
library(kableExtra)
library(knitr)


```
# Trying out scaling with a random saple from all tweets 
```{r}

load("data/non_congress_dfm_full")

#Dataframe with tweets and metadata (object name is "non_congres")
load("data/non_congress_fem_jul_nov_2020.RData")

# When trying to run  data.matrix(non_congress_dfm_full) to get a matrix that ca() can use, we get an error because there are too many counts of 'zero' -too many words appear to seldom.  

sparsity(non_congress_dfm_full)
# meaning that 99.9% of the cells are zeros. 

#We can trim the document feature matrix to remove the features with most empty cells
feminists_trimmed <- dfm_trim(non_congress_dfm_full, min_docfreq = 10, min_termfreq = 20, verbose = TRUE)
# Removing features:
  # That appear less 20 times: 49,928
  # That appear in less than 10 documents: 45,912
  # Total features removed: 49,929 (90.4%).

  # Document-feature matrix of: 68,441 documents, 5,275 features (99.9%       sparse) and 8 docvars

sample_feminists_dfm <- dfm_sample(x = feminists_trimmed, size = 5000, margin = "documents")

# Remove again features with very low or null counts 
sample_feminists_dfm <- dfm_trim(sample_feminists_dfm,  min_termfreq = 5, verbose = TRUE)

# Turn dfm into matrix to work with ca()
feminists_matrix <- data.matrix(sample_feminists_dfm)

# Remove rows with no counts on any of the remaining features
feminists_matrix <- feminists_matrix[rowSums(feminists_matrix != 0) != 0,] 

model_sample <- ca::ca(feminists_matrix)
```

```{r}

# Gather document positions (thetas) and word positions (betas)

theta <- model_random_sample$rowcoor
beta <- model_random_sample$colcoord

theta <- theta %>% 
  as.data.frame() %>% 
  select(Dim1) %>% 
  arrange(desc(Dim1)) %>% 
  rownames_to_column(var = "text_id")

theta <-  theta %>% 
  mutate(screen_name = str_extract(text_id, ".+?(?=_)"),
         tweet_id = str_extract(text_id, "(?<=_).+")) %>% 
  group_by(screen_name) %>% 
  summarise(avg_position = mean(Dim1))
```

```{r}


theta <- left_join(theta, select(non_congress,
                                 c(screen_name,
                                   main_occupation)),
                   by = "screen_name")

theta %>% ggplot(aes(x = avg_position, 
                     y = screen_name,
                     color = main_occupation)) +
  geom_point()  +  
  theme_minimal() +
  labs(y = "",
       x = "Position",
       color = "")
 # scale_y_continuous(labels = thetas_dim1$party_year,
      #               breaks = thetas_dim1$party_order) +
#  labs(x = "Position", y = "", color = "Party") +
#  ggtitle("Estimated Positions from Parties on 'Dimension 1'\n")

```

This makes no sense whatsoever. Probably because the scaling analysis i
presupposes or assumes that the texts are have a series of words chosen to express a certain position. Since these tweets are talking about all sorts of topics, this analysis is flawed. Baed on the topics we identified, We can subet the sample to get only the ones talking about politics and assume that these users are expressing their political position or ideology there. 

# Trying out scaling only with tweets with highest proportion of political topics

```{r}

load("data/ind_tweets_on_politics")
load("data/non_congress_dfm_full")

manifestos <- distinct(tweets_on_politics) %>% group_by(screen_name) %>%
  filter(screen_name != "dianalzuleta") %>% 
  summarize(text = paste(text, collapse = " "))

manifestos_corpus <- corpus(x =  manifestos)

manifestos_dfm <- dfm(manifestos_corpus,
                      tolower = TRUE, # convert all words to lower case 
                      remove = c(stopwords("spanish")),
                      remove_punct = TRUE, # remove punctuation
                      remove_url = TRUE, # remove u
                      remove_numbers = TRUE,
                      remove_symbols = TRUE,
                      verbose = TRUE,
                      stem = T) # Bueno hacer esta opción para ver que está haciendo el dfm.
                #it is better not to stem for topic models  
             
# Remove mentions (@)
manifestos_dfm <- dfm_remove(manifestos_dfm,
                      "@*",
                      verbose = T)

#Remove hashtags         
manifestos_dfm <- dfm_remove(manifestos_dfm,
                      "#*",
                      verbose = T)

# Remove more stopwords (less than 3 characters)
manifestos_dfm <- dfm_keep(manifestos_dfm,
                    min_nchar = 3,
                      verbose = T)

docnames(manifestos_dfm) <- manifestos$screen_name

sparsity(manifestos_dfm)

politics_dfm <- dfm_trim(manifestos_dfm, min_termfreq = 5, verbose = TRUE)

politics_matrix <- data.matrix(politics_dfm)

# Remove rows with no counts on any of the remaining features
politics_matrix <- politics_matrix[rowSums(politics_matrix != 0) != 0,] 

model_politics <- ca(politics_matrix)
```

```{r}

# Gather document positions (thetas) and word positions (betas)

theta <- model_politics$rowcoor

theta <- theta %>% 
  as.data.frame() %>% 
  select(Dim1) %>% 
  arrange(desc(Dim1)) %>% 
  rownames_to_column(var = "screen_name")

meta <- tweets_on_politics %>% select(screen_name, main_occupation)
meta$topic <- NULL
meta <- unique(meta)

theta <- left_join(theta, 
                   meta,
                   by = "screen_name") %>% 
  mutate(user_order = rank(Dim1)) %>% 
  arrange(user_order)

```

```{r}

political_scale_ind <- theta %>% arrange(Dim1, screen_name) %>% 
  ggplot(aes(x = Dim1,
             y = user_order,
             color = main_occupation)) +
  geom_point() +
  scale_y_continuous(labels = theta$screen_name,
                     breaks = theta$user_order) +
  theme_minimal() +
  labs(y = "",
       x = "Position",
       color = "",
       title = "Scale of latent position",
       subtitle = "Based on tweets most likely to talk about the political topics")

political_scale_ind 

ggsave(political_scale_ind, file = "figures/plot_political_scale_ind.png")
```




